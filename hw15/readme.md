# Модульные тесты:

### 1. Тест валидации поля card_number: 

**Правило:**
Если длинна переданного значения не равняется 16-и символам и\или значение содержит не только цифры, то метод валидации должен вернуть false, в любом другом случае - true

**Примеры:**

| Значение          | Ожидаемый результат |
| ----------------- | ------------------- |
| 123456789012345   | false               |
| 123456789012345A  | false               |
| AAAAAAAAAAAAAAAA  | false               |
| 1234AAAAAAAAAAAAA | false               |
| 12345678910123456 | true                |

### 2. Тест валидации поля card_holder:

**Правило:**
Если переданное значение не содержит в себе пробелов или содержит больше одного пробела и\или содержит любые символы не входящие в набор [A-Za-z\-], то метод валидации должен вернуть false, в любом другом случае - true

**Примеры:**

| Значение           | Ожидаемый результат |
| ------------------ | ------------------- |
| Evgeny Pro4horov   | false               |
| Ev-geny Pro4horov  | false               |
| EvgenyProkhorov    | false               |
| Evgeny-Prokhorov   | false               |
| Ev geny Prokhorov  | false               |
| Ev geny Prok horov | false               |
| Evgeny Pro!!horov  | false               |
| Evgeny Pr?kh?r?v   | false               |
| Evg.ny Prokohorv   | false               |
| evgeny prokhorov   | true                |
| Evgeny Prokhorov   | true                |
| EVGENY PROKHOROV   | true                |
| EVGENY PROK-HOROV  | true                |

### 3. Тест валидации поля card_expiration:

**Правило:**
Если переданное значение отличается от формата MM/YY или содержит месяц и год меньше текущего месяца и года (на момент написание примеров - 08/19), то  метод валидации должен вернуть false, в любом другом случае - true

**Примеры:**

| Значение     | Ожидаемый результат |
| ------------ | ------------------- |
| 9/19         | false               |
| октябрь 2019 | false               |
| 09.19        | false               |
| AA/BB        | false               |
| 10/19 !      | false               |
| 06/18        | false               |
| 10/19        | true                |
| 01/20        | true                |

### 4. Тест валидации поля cvv:

**Правило:**
Если длинна переданного значения не равняется 3-м символам и\или значение содержит не только цифры, то метод валидации должен вернуть false, в любом другом случае - true

**Примеры:**

| Значение | Ожидаемый результат |
| -------  | ------------------- |
| AAA      | false               |
| 12A      | false               |
| 1234     | false               |
| 123      | true                |

### 5. Тест валидации поля order_number

**Правило:**
Если передаваемое значение больше 16-и символов, то метод валидации должен вернуть false, в любом другом случае - true

**Примеры:**

| Значение           | Ожидаемый результат |
| ------------------ | ------------------- |
| 123456789012345678 | false               |
| 1224344534534AAA!  | false               |
| 1224344534534AA!   | true                |
| 1234               | true                |
| A                  | true                |

### 6. Тест валидации поля sum

**Правило:**
Если передаваемое значение содержит символы отличающиеся от цифр и/или запятой, а также не содержит запятую или содержит больше чем одну запятую то метод валидации должен вернуть - false. Если до и/или после запятой отсутствуют цифры, то метод также должен вернуть - false. В любых других случаях метод должен возвращать - true.

**Примеры:**

| Значение  | Ожидаемый результат |
| --------- | ------------------- |
| 1200      | false               |
| 123.00    | false               |
| 123,0!    | false               |
| 123,12,00 | false               |
| 1 200,00  | false               |
| ,         | false               |
| 100,      | false               |
| ,20       | false               |
| 1,201     | true                |
| 123,00    | true                |

# Интеграционные тесты:

## Тесты "Фронт - Бекенд"

**Подготовка к тестам (setUp):**

Ответы бекенда зависят еще и от ответов Сервиса А и репозитория, вместо реальных объектов в этих тестах должны быть Mock-объекты т.к. в данном случае мы тестируем только корректную работу связки "Фронт - Бек".

Валидные данные:
```
{
    'card_number': '12345678910123456',
    'card_holder': 'EVGENY PROKHOROV',
    'card_expiration': '10/19',
    'cvv': '123',
    'order_number': '1234567',
    'sum': '123,00',
}
```
Mock-объект сервиса А содержит массив с картами и ответами для них в формате из документации сервиса А:
```
$cardResponse = [
    '12345678910123456' => [
        'return' => [
            'success' => true
            'error' => ''
        ]
    ],
    '12345678910123458' => [
        'return' => [
            'success' => true,
            'error' => 'Wrong CVV'
        ]
    ],
];
```

Mock-объект репозитория содержит заказ:

| order_id | sum    | is_paid |
| -------- | ------ | ------- |
| 1234567  | 123.00 | false   |

### Тесты:

1. При передаче некорректных (невалидных) данных на бекенд, должен быть получен статус 400 и JSON ответа должен содержать массив ошибок

**Подготовка к тесту**

В JSON с валидными данными изменяется несколько полей: 
```
'card_number': '1234567891012345AA'
'cvv': '1234',
```

**Ожидаемый статус ответа:** 400

**Ожидаемый JSON ответ:**
```
{
    'success': false,
    'errors': [
        'Некорректный номер карты'
        'Некорретный CVV'
    ]
}
```

2. При передаче корректных данных на бекенд, но сервис А не смог списать деньги, то должен быть получен статус 403 и JSON ответа должен содержать массив ошибок

**Подготовка к тесту:**

В JSON с валидными данными изменяется значения поля card_number на 12345678910123458

**Ожидаемый статус ответа:** 403

**Ожидаемый JSON ответ:**
```
{
    'success': false,
    'errors': [
        'Не удалось списать средства.'
    ]
}
```

3. При передаче корректных данных на бекенд и сервис А смог списать деньги но списанная сумма не равна сумме в заказе, то должен быть получен статус 500 и JSON ответа должен содержать массив ошибок

**Подготовка к тесту:**
В JSON с валидными данными изменяется значения поля sum на 100,00

**Ожидаемый статус ответа:** 500

**Ожидаемый JSON ответ:**
```
{
    'success': false,
    'errors': [
        'При обработке заказа произошла ошибка. Мы уже знаем о ней и свяжемся с Вами в течении часа'
    ]
}
```

4. Передача корректных данных на бекенд, сервис А смог списать деньги и списанная сумма равна сумме в заказе, то должен быть получен статус 200 и JSON ответа не должен содержать массив ошибок

**Ожидаемый статус ответа:** 200

**Ожидаемый JSON ответ:**
```
{
    'success': true,
    'errors': []
}
```

## Тесты "Бекенд - Репозиторий"

**Подготовка к тестам (setUp):**
Данный тест проводится на тестовой базе данных, в которую предварительно заводится несколько заказов:

| order_id | sum    | is_paid |
| -------- | ------ | ------- |
| 11111111 | 100.00 | false   |
| 11111112 | 100.00 | true    |

### Тесты

1. Если передан существующий заказ и некорректная сумма, то должно быть выброшено исключение WrongSumException

**Пример:**

| order_id | sum    | Ожидаемый результат |
| -------- | ------ | ------------------- |
| 11111111 | 100.01 | WrongSumException   |

2. Если передан несуществующих заказ, то должно быть быть выброшено исключение OrderNotFoundException

**Пример:**

| order_id | sum    | Ожидаемый результат      |
| -------- | ------ | ------------------------ |
| 11111113 | 100.01 | OrderNotFoundException   |

3. Если передан существующий, но уже оплаченный заказ, то должно быть выброшено исключение OrderAlreadyPaidException

**Пример:**

| order_id | sum    | Ожидаемый результат         |
| -------- | ------ | --------------------------- |
| 11111112 | 100.00 | OrderAlreadyPaidException   |

4. Если передан существующий заказ и корректная сумма, а так же заказ еще не был оплачен, метод должен вернуть true

**Пример:**

| order_id | sum    | Ожидаемый результат         |
| -------- | ------ | --------------------------- |
| 11111111 | 100.00 | true                        |

5. Если передан существующий заказ и корректная сумма, а так же заказ еще не был олпачен, то параметр is_paid должен поменятся на true

**Подготовка к тесту:**

Создается новый заказ:

| order_id | sum    | is_paid |
| -------- | ------ | ------- |
| 11111113 | 100.00 | false   |

**Пример:**

| order_id | sum    | Ожидаемое значение is_paid |
| -------- | ------ | -------------------------- |
| 11111113 | 100.00 | true                       |

## Тесты "Бекенд - Сервиса А"
По сути Сервис А - это чужой код то и тестировать его не надо. Но если не протестировать эту связку, то есть большая вероятность потерять деньги и лоялность клиентов. Поэтому сервисы, как правило предоставляют, тестовые номера карт на разные случаи. Есть смысл использовать эти тестовые номера карт на системных тестах.

# Системные тесты

**Подготовка к тестам:**

Набор тестовых карточек с разными ошибками, например:

| card_number         | cvv | success | error              |
| ------------------- | --- | ------- | ------------------ |
| 4444 4444 4444 4444 | 123 | true    |                    | 
| 5555 5555 5555 5555 | 123 | false   | insufficient_funds | 
| 6666 6666 6666 6666 | 123 | false   | expired_date       | 

Дополнительные данные для ввода:
```
{
    'card_holder': 'EVGENY PROKHOROV',
    'card_expiration': '10/19',
}
```

## Сценарий

1. Пользователь выбирает места на фильм и нажимает кнопку оплатить
2. Открывается страница для оплаты с карты
3. Если пользователь вводит номер карты 4444 4444 4444 4444 и card_expiration: 06/01, то на экране должен появиться блок с ошибкой "Некорректная дата"
4. Если пользователь вводит номер карты 4444 4444 4444 4444 и cvv 234, то на экране должен появиться с блок с ошибкой "Не удалось списать средства"
5. Если пользователь вводит номер карты 5555 5555 5555 5555 и cvv 123, то на экране должен появиться с блок с ошибкой "Недостаточно средств"
6. Если пользователь вводит номер карты 4444 4444 4444 4444 и cvv 123, то его перекидывает на страницу с сообщением: Билеты успешно оплачены. Приятного просмотра!